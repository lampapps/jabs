{% extends "base.html" %}
{% block title %}Scheduler Heartbeat{% endblock %}
{% block top_scripts %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="mb-4">
      <h2 class="mb-0">Backup Job Scheduler</h2>
      <div class="mb-2">
          <span class="fs-6">Set up a method to run <code>scheduler.py</code> to trigger your backup jobs</span>
      </div>
  </div>
  <div class="card">
    <div class="card-header">
      <strong>Scheduler Heartbeat</strong>
    </div>
    <div class="card-body" style="height: 150px;">
      <div class="mb-3">
        <span class="fs-6">Each bar shows a scheduler run. Hover for details.</span>
      </div>
      <canvas id="heartbeatChart" height="30"></canvas>
    </div>
  </div>
  <div class="card mt-4">
    <div class="card-header">
      <strong>How to Schedule the JABS Scheduler</strong>
    </div>
    <div class="card-body">
      <div class="mb-2">
        <strong>Python interpreter:</strong> <code>{{ venv_python }}</code><br>
        <strong>Scheduler script:</strong> <code>{{ scheduler_py }}</code>
      </div>
      <hr>
      <div class="mb-2">
        <strong>Linux/macOS (Cron):</strong>
        <pre class="mb-2"><code>0 * * * * {{ venv_python }} {{ scheduler_py }}</code></pre>
        <div class="small text-muted">
          Add the above line to your crontab (run <code>crontab -e</code>) to run the scheduler every hour.
        </div>
      </div>
      <div class="mb-2">
        <strong>Windows (Task Scheduler):</strong>
        <ol class="mb-1">
          <li>Open <b>Task Scheduler</b> and create a new Basic Task.</li>
          <li>Set your desired trigger (e.g., hourly).</li>
          <li>For <b>Program/script</b>, enter:<br>
            <code>{{ venv_python|replace('/', '\\') }}</code>
          </li>
          <li>For <b>Add arguments</b>, enter:<br>
            <code>{{ scheduler_py|replace('/', '\\') }}</code>
          </li>
          <li>Finish and enable the task.</li>
        </ol>
        <div class="small text-muted">
          Make sure the paths above match your installation. You can test by running the command in a terminal first.
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('heartbeatChart').getContext('2d');
const times = {{ times|tojson }}; // e.g. "2025-05-27 03:00:01"
const triggers = {{ triggers|tojson }};
const errors = {{ errors|tojson }};
const jobnames = {{ jobnames|tojson }};

const data = triggers.map(() => 1);
const colors = triggers.map((t, i) => {
  if (t === 0) return 'rgba(108,117,125,0.5)';
  if (errors[i]) return 'rgba(220,53,69,0.8)';
  return 'rgba(40,167,69,0.8)';
});

// Custom tick callback for x-axis
function customTickCallback(value, index, ticks) {
  const current = times[index];
  const prev = index > 0 ? times[index - 1] : null;
  const [curDate, curTime] = current.split(' ');
  if (!prev) return curDate; // First tick: show date
  const [prevDate] = prev.split(' ');
  if (curDate !== prevDate) {
    return curDate; // Date changed: show date
  }
  return curTime.slice(0,5); // Otherwise, show HH:MM
}

new Chart(ctx, {
  type: 'bar',
  data: {
    labels: times, // Use full datetime as label
    datasets: [{
      label: 'Scheduler Ran',
      data: data,
      backgroundColor: colors,
      borderColor: colors,
      borderWidth: 2,
      barPercentage: 1.0,
      categoryPercentage: 1.0
    }]
  },
  options: {
    plugins: {
      legend: { display: false },
      tooltip: {
        callbacks: {
          title: function(context) {
            return times[context[0].dataIndex];
          },
          label: function(context) {
            const idx = context.dataIndex;
            const t = triggers[idx];
            const jobs = jobnames[idx];
            if (t === 0) {
              return 'No jobs triggered';
            } else if (errors[idx]) {
              return `${t} job(s) triggered (error)` + (jobs ? `: ${jobs}` : '');
            } else {
              return `${t} job(s) triggered` + (jobs ? `: ${jobs}` : '');
            }
          }
        }
      }
    },
    scales: {
      x: {
        title: { display: true, text: 'Date/Time' },
        ticks: {
          maxTicksLimit: 20,
          autoSkip: true,
          callback: customTickCallback
        }
      },
      y: {
        display: false,
        min: 0,
        max: 1.2
      }
    },
    elements: {
      bar: {
        borderRadius: 4
      }
    }
  }
});
</script>
{% endblock %}