{% extends "base.html" %}
{% block title %}Monitor{% endblock %}
{% block top_scripts %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/monitor.css') }}">
{% endblock %}
{% block content %}
<div class="container my-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">Monitor</h2>
            <div class="mb-2">
                <span class="fs-6">Monitor JABS instances on local network</span>
            </div>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-primary btn-sm" id="discover-btn" onclick="discoverInstances()">
                <i class="fa fa-search"></i> Auto-Discover
            </button>
            <a class="btn btn-warning btn-sm"
               href="{{ url_for('config.edit_config', filename='monitor.yaml', next=url_for('monitor.monitor')) }}">
                <i class="fa fa-edit"></i> Edit Config
            </a>
        </div>
    </div>

    <!-- Discovery Status -->
    <div id="discovery-status" class="alert alert-info discovery-status">
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            <span id="discovery-message">Scanning network for JABS instances...</span>
        </div>
    </div>

    <!-- Auto-Discovered Instances Table -->
    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>Discovered Instances</h4>
            <button class="btn btn-outline-secondary btn-sm" onclick="refreshDiscoveredInstances()">
                <i class="fa fa-refresh"></i> Refresh
            </button>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="discovered-instances-table">
                <thead class="table-dark">
                    <tr>
                        <th colspan="3" class="text-center"></th>
                        <th colspan="3" class="text-center group-header-cli">CRON Schedule</th>
                        <th colspan="3" class="text-center group-header-flask">Web Interface</th>
                        <th class="group-header-actions"></th>
                    </tr>
                    <tr>
                        <th>Hostname</th>
                        <th>IP Address</th>
                        <th>Version</th>
                        <th class="group-border-cli-start">Status</th>
                        <th>Errors</th>
                        <th class="group-border-cli-end">Grace Period</th>
                        <th class="group-border-flask-start">Status</th>
                        <th>Errors</th>
                        <th class="group-border-flask-end">Open</th>
                        <th class="group-border-actions">Delete</th>
                    </tr>
                </thead>
                <tbody id="discovered-instances-tbody">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    </div>
</div>

<!-- Grace Period Edit Modal -->
<div class="modal fade" id="gracePeriodModal" tabindex="-1" aria-labelledby="gracePeriodModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="gracePeriodModalLabel">Edit Grace Period</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="gracePeriodInput" class="form-label">Grace Period (minutes)</label>
                    <input type="number" class="form-control" id="gracePeriodInput" min="1" max="1440">
                    <div class="form-text">Time to wait before marking CRON as stopped (1-1440 minutes)</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveGracePeriod()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
<script src="{{ url_for('static', filename='js/global.js') }}"></script>
<script src="{{ url_for('static', filename='js/monitor.js') }}"></script>
{% endblock %}