{% extends "base.html" %}
{% block title %}Backup Jobs{% endblock %}
{% block top_scripts %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">Backup Jobs</h2>
            <div class="mb-2">
                <span class="fs-6">Configure backup job specific settings. Create new job using <code>Template:job.yaml</code> to see detailed instructions.</span>
            </div>
        </div>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createJobModal">
            <i class="fa fa-plus"></i> New Job
        </button>
    </div>
    <div class="row g-4">
        {% for config in configs %}
        <div class="col-12 col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>
                        <i class="fa fa-file-code me-2"></i>
                        {{ config.job_name or config.file_name|replace('.yaml','') }}
                    </span>
                    <span class="badge bg-secondary">{{ config.file_name }}</span>
                </div>
                <div class="card-body d-flex flex-column">
                    <ul class="mb-0 small">
                        <li><b>Source:</b> <code>{{ config.source or 'Not set' }}</code></li>
                        <li><b>Destination:</b> <code>{{ config.destination or 'Not set' }}</code></li>
                        <li><b>Encryption:</b>
                            <ul>
                                <li>
                                    Enabled:
                                    {% set enc_enabled = (config.data and config.data.get('encryption', {}).get('enabled')) 
                                        if config.data and 'encryption' in config.data 
                                        else global_config.get('encryption', {}).get('enabled', False) %}
                                    {% if enc_enabled %}
                                        <span class="badge bg-success">True</span>
                                    {% else %}
                                        <span class="badge bg-secondary">False</span>
                                    {% endif %}
                                </li>
                            </ul>
                        </li>
                        <li><b>Sync to S3:</b>
                            <ul>
                                <li>
                                    Enabled:
                                    {% if config.aws_enabled %}
                                        <span class="badge bg-success">True</span>
                                    {% else %}
                                        <span class="badge bg-secondary">False</span>
                                    {% endif %}
                                </li>
                            </ul>
                        </li>
                        <li><b>Schedules:</b>
                            {% if config.data and config.data.get('schedules') %}
                                <ul class="mb-0 ps-3">
                                    {% for sched in config.data.schedules %}
                                        <li class="mb-1">
                                            {% if sched.enabled %}
                                                <span class="text-success">
                                                    {{ sched.type|capitalize if sched.type else '' }}: {{ sched.cron_human }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">
                                                    {{ sched.type|capitalize if sched.type else '' }}: {{ sched.cron_human }} (Disabled)
                                                </span>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <span class="text-muted">No schedules</span>
                            {% endif %}
                        </li>
                    </ul>
                </div>
                <div class="card-footer d-flex flex-wrap gap-2 justify-content-end">
                    <!-- Run Job Button -->
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#runJobModal-{{ config.file_name|replace('.', '-') }}">
                        <i class="fa fa-play"></i> Run
                    </button>
                    <!-- Edit Button (direct link, no modal) -->
                    <a class="btn btn-warning btn-sm"
                       href="{{ url_for('config.edit_config', filename=config.file_name, next=url_for('jobs.jobs_view')) }}">
                        <i class="fa fa-edit"></i> Edit
                    </a>
                    <!-- View Button -->
                    <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#viewJobModal-{{ config.file_name|replace('.', '-') }}">
                        <i class="fa fa-eye"></i> View
                    </button>
                    <!-- Delete Button -->
                    <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteJobModal-{{ config.file_name|replace('.', '-') }}">
                        <i class="fa fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>

        <!-- Run Job Modal -->
        <div class="modal fade" id="runJobModal-{{ config.file_name|replace('.', '-') }}" tabindex="-1" aria-labelledby="runJobLabel-{{ config.file_name|replace('.', '-') }}" aria-hidden="true">
          <div class="modal-dialog">
            <form method="post" action="{{ url_for('jobs.run_job', filename=config.file_name) }}" class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="runJobLabel-{{ config.file_name|replace('.', '-') }}">Run {{ config.file_name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Backup Type:</label>
                    <select name="backup_type" class="form-select">
                        <option value="full">Full</option>
                        <option value="diff">Differential</option>
                    </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Run</button>
              </div>
            </form>
          </div>
        </div>

        <!-- View Modal -->
        <div class="modal fade" id="viewJobModal-{{ config.file_name|replace('.', '-') }}" tabindex="-1" aria-labelledby="viewJobLabel-{{ config.file_name|replace('.', '-') }}" aria-hidden="true">
          <div class="modal-dialog modal-dialog-scrollable" style="max-width: 50vw;">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="viewJobLabel-{{ config.file_name|replace('.', '-') }}">View {{ config.file_name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                {% set job_config = config.data %}
                {% set job_encryption = config.data.get('encryption', {}) if config.data else {} %}
                {% set global_encryption = global_config.get('encryption', {}) if global_config else {} %}
                {% include "partials/job_config_summary.html" %}
              </div>
            </div>
          </div>
        </div>

        <!-- Delete Modal -->
        <div class="modal fade" id="deleteJobModal-{{ config.file_name|replace('.', '-') }}" tabindex="-1" aria-labelledby="deleteJobLabel-{{ config.file_name|replace('.', '-') }}" aria-hidden="true">
          <div class="modal-dialog">
            <form method="post" action="{{ url_for('jobs.delete_config', filename=config.file_name) }}" class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="deleteJobLabel-{{ config.file_name|replace('.', '-') }}">Delete {{ config.file_name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p>Are you sure you want to delete <strong>{{ config.file_name }}</strong>? This action cannot be undone.</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger">Delete</button>
              </div>
            </form>
          </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Create Job Modal -->
<div class="modal fade" id="createJobModal" tabindex="-1" aria-labelledby="createJobLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form method="post" action="{{ url_for('jobs.copy_config') }}" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createJobLabel">Create New Job</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
            <label for="copy_source" class="form-label">Copy from:</label>
            <select name="copy_source" id="copy_source" class="form-select" required>
                <option value="" disabled selected>Select template or job</option>
                {% for t in templates %}
                    <option value="templates/{{ t }}">Template: {{ t }}</option>
                {% endfor %}
                {% for config in configs %}
                    <option value="{{ config.file_name }}">Job: {{ config.file_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label for="new_job_name" class="form-label">Job Name:</label>
            <input type="text" name="new_job_name" id="new_job_name" class="form-control"
                   placeholder="My Backup Job" required pattern="^[\w\- ]+$" oninput="updateFileNamePreview()">
            <div class="form-text">
                File will be saved as: <span id="fileNamePreview"></span>
            </div>
        </div>
        <input type="hidden" name="next" value="{{ url_for('jobs.jobs_view') }}">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Create</button>
      </div>
    </form>
  </div>
</div>
<script>
function updateFileNamePreview() {
    let name = document.getElementById('new_job_name').value.trim().replace(/\s+/g, '_');
    name = name.replace(/[^\w\-]/g, '');
    document.getElementById('fileNamePreview').textContent = name ? (name + '.yaml') : '';
}
</script>
{% endblock %}
{% block scripts %}
<script src="{{ url_for('static', filename='js/global.js') }}"></script>
{% endblock %}