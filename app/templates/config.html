{% extends "base.html" %}

{% block title %}JABS Configuration Files{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="mb-4">JABS Configuration Files</h1>
    <p class="text-muted mb-4">
        Each backup job requires its own configuration file. Use this page to view, edit, copy, rename, or delete configuration files for your backup jobs. System files like <code>drives.yaml</code> and <code>example.yaml</code> cannot be renamed or deleted.
    </p>
    <div class="mb-3 text-end">
        <!-- Button to trigger copy modal -->
        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#copyModal">Copy/Create New Config</button>
    </div>
    <div class="table-responsive">
        <table class="table table-striped align-middle">
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>Preview</th>
                    <th style="width: 220px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for config in configs %}
                <tr>
                    <td>{{ config.file_name }}</td>
                    <td>
                        <pre class="bg-dark text-light p-2 rounded" style="max-height: 120px; min-width: 200px; overflow:auto; font-size: 0.9em; white-space: pre-wrap; word-break: break-all;">{{ config.raw_data[:500] }}{% if config.raw_data|length > 500 %}...{% endif %}</pre>
                    </td>
                    <td>
                        <a href="{{ url_for('dashboard.edit_config', filename=config.file_name) }}" class="btn btn-warning btn-sm mb-1">Edit</a>
                        {% if config.file_name != "drives.yaml" and config.file_name != "example.yaml" %}
                            <!-- Rename Button triggers modal -->
                            <button type="button" class="btn btn-secondary btn-sm mb-1" data-bs-toggle="modal" data-bs-target="#renameModal-{{ config.file_name|replace('.', '-') }}">
                                Rename
                            </button>
                        {% endif %}
                        <!-- View Full Button (optional) -->
                        <button type="button" class="btn btn-info btn-sm mb-1" data-bs-toggle="modal" data-bs-target="#viewModal-{{ config.file_name|replace('.', '-') }}">
                            View
                        </button>
                        {% if config.file_name != "drives.yaml" and config.file_name != "example.yaml" %}
                            <!-- Delete Button triggers modal -->
                            <button type="button" class="btn btn-danger btn-sm mb-1" data-bs-toggle="modal" data-bs-target="#deleteModal-{{ config.file_name|replace('.', '-') }}">
                                Delete
                            </button>
                        {% endif %}
                    </td>
                </tr>
                <!-- Rename Modal -->
                {% if config.file_name != "drives.yaml" and config.file_name != "example.yaml" %}
                <div class="modal fade" id="renameModal-{{ config.file_name|replace('.', '-') }}" tabindex="-1" aria-labelledby="renameModalLabel-{{ config.file_name|replace('.', '-') }}" aria-hidden="true">
                  <div class="modal-dialog">
                    <form method="post" action="{{ url_for('dashboard.rename_config', filename=config.file_name) }}">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="renameModalLabel-{{ config.file_name|replace('.', '-') }}">Rename {{ config.file_name }}</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <div class="mb-3">
                            <label for="new_name_{{ config.file_name|replace('.', '-') }}" class="form-label">New filename</label>
                            <input type="text" class="form-control" id="new_name_{{ config.file_name|replace('.', '-') }}" name="new_filename" placeholder="new_job.yaml" required pattern="^[\w\-]+\.yaml$">
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <button type="submit" class="btn btn-primary">Rename</button>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
                {% endif %}
                <!-- Delete Modal -->
                {% if config.file_name != "drives.yaml" and config.file_name != "example.yaml" %}
                <div class="modal fade" id="deleteModal-{{ config.file_name|replace('.', '-') }}" tabindex="-1" aria-labelledby="deleteModalLabel-{{ config.file_name|replace('.', '-') }}" aria-hidden="true">
                  <div class="modal-dialog">
                    <form method="post" action="{{ url_for('dashboard.delete_config', filename=config.file_name) }}">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="deleteModalLabel-{{ config.file_name|replace('.', '-') }}">Delete {{ config.file_name }}</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <p>Are you sure you want to delete <strong>{{ config.file_name }}</strong>? This action cannot be undone.</p>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <button type="submit" class="btn btn-danger">Delete</button>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
                {% endif %}
                <!-- View Modal -->
                <div class="modal fade" id="viewModal-{{ config.file_name|replace('.', '-') }}" tabindex="-1" aria-labelledby="viewModalLabel-{{ config.file_name|replace('.', '-') }}" aria-hidden="true">
                  <div class="modal-dialog modal-fullscreen">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="viewModalLabel-{{ config.file_name|replace('.', '-') }}">View {{ config.file_name }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <pre class="bg-dark text-light p-3 rounded" style="height: 80vh; min-width: 100vw; overflow:auto; white-space: pre-wrap; word-break: break-all;">{{ config.raw_data }}</pre>
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Copy/Create Modal -->
<div class="modal fade" id="copyModal" tabindex="-1" aria-labelledby="copyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{{ url_for('dashboard.copy_config') }}">
      <div class="modal-header">
        <h5 class="modal-title" id="copyModalLabel">Copy/Create New Config</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
            <label for="copy_source" class="form-label">Copy from:</label>
            <select name="copy_source" id="copy_source" class="form-select" required>
                <option value="" disabled selected>Select YAML file</option>
                {% for config in configs %}
                    {% if config.file_name != "drives.yaml" %}
                        <option value="{{ config.file_name }}">{{ config.file_name }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label for="new_filename" class="form-label">New filename:</label>
            <input type="text" name="new_filename" id="new_filename" class="form-control" placeholder="new_job.yaml" required pattern="^[\w\-]+\.yaml$">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Copy & Edit</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}

{% endblock %}